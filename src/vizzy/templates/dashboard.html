{% extends "base.html" %}

{% set current_page = 'dashboard' %}

{% block title %}{{ import_info.name }} - Dashboard{% endblock %}

{% block head_extra %}
<link rel="stylesheet" href="/static/css/dashboard.css">
{% endblock %}

{% block nav_extra %}
{# Search input in navigation #}
<div class="nav-search">
    <svg class="nav-search-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24" aria-hidden="true">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
    </svg>
    <input type="search"
           placeholder="Search packages..."
           class="nav-search-input"
           hx-get="/search?import_id={{ import_info.id }}"
           hx-trigger="keyup changed delay:300ms"
           hx-target="#search-results"
           name="q"
           aria-label="Search packages">
</div>
{% endblock %}

{% block content %}
<div class="dashboard">
    <!-- Metrics Row -->
    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
        <!-- Total Derivations -->
        <div class="metric-card bg-white rounded-lg shadow p-4" role="group" aria-labelledby="metric-derivations-label">
            <span id="metric-derivations-label" class="sr-only">Total derivations in this configuration</span>
            <div class="text-3xl font-bold text-slate-700">
                {% if summary %}
                    {{ "{:,}".format(summary.total_nodes) }}
                {% else %}
                    <span class="animate-pulse bg-slate-200 h-8 w-24 block rounded"></span>
                {% endif %}
            </div>
            <div class="text-sm text-slate-500">derivations</div>
            {% if summary and summary.baseline_comparison %}
            <div class="text-xs mt-1 {{ 'text-red-500' if summary.baseline_comparison.percentage > 0 else 'text-green-500' }}">
                {{ "+" if summary.baseline_comparison.percentage > 0 else "" }}{{ summary.baseline_comparison.percentage }}% vs {{ summary.baseline_comparison.baseline_name }}
            </div>
            {% endif %}
        </div>

        <!-- Redundancy Score -->
        <div class="metric-card bg-white rounded-lg shadow p-4" role="group" aria-labelledby="metric-redundancy-label">
            <span id="metric-redundancy-label" class="sr-only">Redundancy score - percentage of redundant dependency edges</span>
            <div class="text-3xl font-bold {% if summary and summary.redundancy_score > 0.1 %}text-amber-500{% else %}text-slate-700{% endif %}">
                {% if summary %}
                    {{ "%.1f"|format(summary.redundancy_score * 100) }}%
                {% else %}
                    <span class="animate-pulse bg-slate-200 h-8 w-20 block rounded"></span>
                {% endif %}
            </div>
            <div class="text-sm text-slate-500">redundancy</div>
            {% if summary and summary.redundancy_score > 0.1 %}
            <div class="text-xs text-amber-500 flex items-center gap-1 mt-1">
                <svg class="w-3 h-3" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd"/>
                </svg>
                high
            </div>
            {% elif summary %}
            <div class="text-xs text-green-500 mt-1">healthy</div>
            {% endif %}
        </div>

        <!-- Runtime Ratio -->
        <div class="metric-card bg-white rounded-lg shadow p-4" role="group" aria-labelledby="metric-runtime-label">
            <span id="metric-runtime-label" class="sr-only">Percentage of runtime dependencies versus build-time dependencies</span>
            <div class="text-3xl font-bold text-slate-700">
                {% if summary %}
                    {{ "%.0f"|format(summary.build_runtime_ratio * 100) }}%
                {% else %}
                    <span class="animate-pulse bg-slate-200 h-8 w-16 block rounded"></span>
                {% endif %}
            </div>
            <div class="text-sm text-slate-500 mb-2">runtime deps</div>
            {% if summary %}
            <div class="w-full bg-slate-200 rounded-full h-2">
                <div class="bg-blue-500 h-2 rounded-full transition-all duration-500"
                     style="width: {{ summary.build_runtime_ratio * 100 }}%"
                     role="progressbar"
                     aria-valuenow="{{ summary.build_runtime_ratio * 100 }}"
                     aria-valuemin="0"
                     aria-valuemax="100"></div>
            </div>
            {% endif %}
        </div>

        <!-- Depth Stats -->
        <div class="metric-card bg-white rounded-lg shadow p-4" role="group" aria-labelledby="metric-depth-label">
            <span id="metric-depth-label" class="sr-only">Average dependency chain depth</span>
            <div class="text-3xl font-bold text-slate-700">
                {% if summary and summary.depth_stats %}
                    {{ "%.1f"|format(summary.depth_stats.avg) }}
                {% else %}
                    <span class="animate-pulse bg-slate-200 h-8 w-12 block rounded"></span>
                {% endif %}
            </div>
            <div class="text-sm text-slate-500">avg depth</div>
            {% if summary and summary.depth_stats %}
            <div class="text-xs text-slate-400 mt-1">max: {{ summary.depth_stats.max or 'N/A' }}</div>
            {% endif %}
        </div>
    </div>

    <!-- Main Content Panels -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
        <!-- Top Contributors -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="font-semibold text-lg mb-4">Largest Contributors</h2>
            <div id="contributors"
                 hx-get="/dashboard/{{ import_info.id }}/contributors"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <!-- Loading state -->
                <div class="space-y-3">
                    {% for i in range(5) %}
                    <div class="flex items-center gap-3 animate-pulse">
                        <div class="flex-1">
                            <div class="h-4 bg-slate-200 rounded w-24 mb-1"></div>
                            <div class="h-2 bg-slate-100 rounded w-full"></div>
                        </div>
                        <div class="h-4 bg-slate-200 rounded w-12"></div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            <a href="/treemap/{{ import_info.id }}"
               class="text-sm text-blue-600 hover:text-blue-800 mt-4 inline-block">
                View Treemap &rarr;
            </a>
        </div>

        <!-- Type Distribution -->
        <div class="bg-white rounded-lg shadow p-4">
            <h2 class="font-semibold text-lg mb-4">By Package Type</h2>
            <div id="type-distribution"
                 hx-get="/dashboard/{{ import_info.id }}/types"
                 hx-trigger="load"
                 hx-swap="innerHTML">
                <!-- Loading state -->
                <div class="flex items-center justify-center h-48">
                    <div class="animate-pulse flex flex-col items-center">
                        <div class="w-32 h-32 bg-slate-200 rounded-full mb-4"></div>
                        <div class="h-4 bg-slate-200 rounded w-24"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow p-4">
        <h2 class="font-semibold text-lg mb-4">Quick Actions</h2>
        <div class="flex flex-wrap gap-3">
            <a href="/analyze/duplicates/{{ import_info.id }}"
               class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium text-slate-700 transition-colors flex items-center gap-2"
               data-navigable>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                </svg>
                Find Duplicates
            </a>
            <a href="/treemap/{{ import_info.id }}"
               class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium text-slate-700 transition-colors flex items-center gap-2"
               data-navigable>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"/>
                </svg>
                View Treemap
            </a>
            <a href="/why-chain/{{ import_info.id }}"
               class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium text-slate-700 transition-colors flex items-center gap-2"
               data-navigable>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/>
                </svg>
                Why Chain
            </a>
            <a href="/compare?left={{ import_info.id }}"
               class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium text-slate-700 transition-colors flex items-center gap-2"
               data-navigable>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4"/>
                </svg>
                Compare Hosts
            </a>
            <a href="/analyze/loops/{{ import_info.id }}"
               class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium text-slate-700 transition-colors flex items-center gap-2"
               data-navigable>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"/>
                </svg>
                Circular Deps
            </a>
            <a href="/analyze/redundant/{{ import_info.id }}"
               class="quick-action-btn px-4 py-2 bg-slate-100 hover:bg-slate-200 rounded text-sm font-medium text-slate-700 transition-colors flex items-center gap-2"
               data-navigable>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                </svg>
                Redundant Links
            </a>
        </div>
    </div>

    <!-- Search Results (hidden until search) -->
    <div id="search-results" class="mt-4"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Dashboard-specific JavaScript
document.addEventListener('DOMContentLoaded', function() {
    // Initialize cross-view state with current import
    if (window.CrossViewState) {
        CrossViewState.updateContext({
            importId: {{ import_info.id }},
            nodeId: null  // Clear selected node when viewing dashboard
        });
    }

    // Handle HTMX events for contributors and type distribution
    document.body.addEventListener('htmx:afterSwap', function(event) {
        if (event.detail.target.id === 'type-distribution') {
            // Initialize chart if needed (for future Chart.js integration)
            initializeTypeChart();
        }
    });
});

function initializeTypeChart() {
    // Placeholder for Chart.js initialization
    // Will be implemented in 8B-003 when the API endpoints are ready
    const chartContainer = document.getElementById('type-distribution');
    if (chartContainer && chartContainer.querySelector('canvas')) {
        // Chart initialization will go here
    }
}
</script>
{% endblock %}
