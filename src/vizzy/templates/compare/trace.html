{% extends "base.html" %}

{% block title %}Package Trace: {{ package or 'Compare' }} - Vizzy{% endblock %}

{% block nav_extra %}
<span class="text-slate-400 mx-2">/</span>
<a href="/compare" class="text-slate-300 hover:text-white">Compare</a>
<span class="text-slate-400 mx-2">/</span>
<a href="/compare?left={{ left.id }}&right={{ right.id }}" class="text-slate-300 hover:text-white">
    {{ left.name }} vs {{ right.name }}
</a>
<span class="text-slate-400 mx-2">/</span>
<span class="text-slate-300">Trace{% if package %}: {{ package }}{% endif %}</span>
{% endblock %}

{% block content %}
<div class="mb-4">
    <nav class="text-sm text-slate-500">
        <a href="/" class="hover:text-slate-700">Home</a>
        <span class="mx-2">&gt;</span>
        <a href="/compare" class="hover:text-slate-700">Compare</a>
        <span class="mx-2">&gt;</span>
        <a href="/compare?left={{ left.id }}&right={{ right.id }}" class="hover:text-slate-700">
            {{ left.name }} vs {{ right.name }}
        </a>
        <span class="mx-2">&gt;</span>
        <span class="text-slate-700">Package Trace</span>
    </nav>
</div>

<div class="bg-white rounded-lg shadow p-6 mb-6">
    <h1 class="text-2xl font-bold mb-2">Package Trace Comparison</h1>
    <p class="text-slate-600 mb-4">
        Compare how a specific package is reached through the dependency chain in two different configurations.
        This helps understand why a package appears and through which path.
    </p>

    <!-- Search Form -->
    <form action="/compare/trace/{{ left.id }}/{{ right.id }}" method="GET" class="flex gap-4">
        <input type="text" name="package"
               value="{{ package or '' }}"
               placeholder="Enter package name (e.g., openssl-3.0.12)"
               class="flex-1 px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
        <button type="submit"
                class="px-6 py-2 bg-blue-500 text-white rounded-lg hover:bg-blue-600 transition">
            Trace
        </button>
    </form>
</div>

{% if trace %}
<div class="bg-white rounded-lg shadow p-6">
    <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">
            Trace: <span class="text-blue-600">{{ trace.package }}</span>
        </h2>
        {% if trace.in_both %}
            {% if trace.same_hash %}
            <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
                Identical in both
            </span>
            {% else %}
            <span class="px-3 py-1 bg-amber-100 text-amber-700 rounded-full text-sm font-medium">
                Different versions
            </span>
            {% endif %}
        {% elif trace.left_node %}
        <span class="px-3 py-1 bg-red-100 text-red-700 rounded-full text-sm font-medium">
            Only in {{ left.name }}
        </span>
        {% elif trace.right_node %}
        <span class="px-3 py-1 bg-green-100 text-green-700 rounded-full text-sm font-medium">
            Only in {{ right.name }}
        </span>
        {% else %}
        <span class="px-3 py-1 bg-slate-100 text-slate-700 rounded-full text-sm font-medium">
            Not found in either
        </span>
        {% endif %}
    </div>

    {% if not trace.left_node and not trace.right_node %}
    <div class="text-center py-8">
        <svg class="w-16 h-16 mx-auto text-slate-300 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                  d="M9.172 16.172a4 4 0 015.656 0M9 10h.01M15 10h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
        </svg>
        <p class="text-slate-500 text-lg">Package "{{ trace.package }}" was not found in either configuration.</p>
        <p class="text-slate-400 text-sm mt-2">Try a different package name or check for typos.</p>
    </div>
    {% else %}

    <!-- Side by Side Comparison -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <!-- Left Config Paths -->
        <div class="border border-slate-200 rounded-lg p-4 {% if not trace.left_node %}bg-slate-50{% endif %}">
            <h3 class="font-semibold mb-4 flex items-center gap-2">
                <span class="w-3 h-3 bg-red-400 rounded-full"></span>
                {{ left.name }}
            </h3>

            {% if trace.left_node %}
            <div class="mb-4 p-3 bg-slate-50 rounded">
                <div class="flex items-center justify-between">
                    <a href="/graph/node/{{ trace.left_node.id }}" class="font-medium text-blue-600 hover:underline">
                        {{ trace.left_node.label }}
                    </a>
                    <span class="text-xs text-slate-400 font-mono">{{ trace.left_node.drv_hash[:12] }}...</span>
                </div>
                {% if trace.left_node.package_type %}
                <span class="inline-block mt-1 px-2 py-0.5 bg-slate-200 text-slate-600 text-xs rounded">
                    {{ trace.left_node.package_type }}
                </span>
                {% endif %}
            </div>

            <h4 class="text-sm font-medium text-slate-600 mb-3">
                Dependency Paths ({{ trace.left_paths|length }}):
            </h4>

            {% if trace.left_paths %}
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for path in trace.left_paths %}
                <div class="p-3 bg-red-50 border border-red-100 rounded">
                    <div class="flex flex-wrap items-center gap-1 text-sm">
                        {% for node in path %}
                        {% if not loop.first %}
                        <svg class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                        {% endif %}
                        <a href="/graph/node/{{ node.id }}"
                           class="px-2 py-0.5 {% if loop.last %}bg-red-200 text-red-800{% else %}bg-white text-slate-700{% endif %} rounded hover:bg-red-100 transition truncate max-w-32"
                           title="{{ node.label }}">
                            {{ node.label[:25] }}{% if node.label|length > 25 %}...{% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-slate-400 italic">No paths found (package may be a root)</p>
            {% endif %}
            {% else %}
            <div class="text-center py-8">
                <svg class="w-12 h-12 mx-auto text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                <p class="text-slate-400">Not present in this configuration</p>
            </div>
            {% endif %}
        </div>

        <!-- Right Config Paths -->
        <div class="border border-slate-200 rounded-lg p-4 {% if not trace.right_node %}bg-slate-50{% endif %}">
            <h3 class="font-semibold mb-4 flex items-center gap-2">
                <span class="w-3 h-3 bg-green-400 rounded-full"></span>
                {{ right.name }}
            </h3>

            {% if trace.right_node %}
            <div class="mb-4 p-3 bg-slate-50 rounded">
                <div class="flex items-center justify-between">
                    <a href="/graph/node/{{ trace.right_node.id }}" class="font-medium text-blue-600 hover:underline">
                        {{ trace.right_node.label }}
                    </a>
                    <span class="text-xs text-slate-400 font-mono">{{ trace.right_node.drv_hash[:12] }}...</span>
                </div>
                {% if trace.right_node.package_type %}
                <span class="inline-block mt-1 px-2 py-0.5 bg-slate-200 text-slate-600 text-xs rounded">
                    {{ trace.right_node.package_type }}
                </span>
                {% endif %}
            </div>

            <h4 class="text-sm font-medium text-slate-600 mb-3">
                Dependency Paths ({{ trace.right_paths|length }}):
            </h4>

            {% if trace.right_paths %}
            <div class="space-y-3 max-h-96 overflow-y-auto">
                {% for path in trace.right_paths %}
                <div class="p-3 bg-green-50 border border-green-100 rounded">
                    <div class="flex flex-wrap items-center gap-1 text-sm">
                        {% for node in path %}
                        {% if not loop.first %}
                        <svg class="w-4 h-4 text-slate-400 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6" />
                        </svg>
                        {% endif %}
                        <a href="/graph/node/{{ node.id }}"
                           class="px-2 py-0.5 {% if loop.last %}bg-green-200 text-green-800{% else %}bg-white text-slate-700{% endif %} rounded hover:bg-green-100 transition truncate max-w-32"
                           title="{{ node.label }}">
                            {{ node.label[:25] }}{% if node.label|length > 25 %}...{% endif %}
                        </a>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-sm text-slate-400 italic">No paths found (package may be a root)</p>
            {% endif %}
            {% else %}
            <div class="text-center py-8">
                <svg class="w-12 h-12 mx-auto text-slate-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                          d="M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636" />
                </svg>
                <p class="text-slate-400">Not present in this configuration</p>
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Help Section -->
<div class="mt-6 bg-white rounded-lg shadow p-4">
    <h3 class="font-semibold mb-3">Understanding Package Traces</h3>
    <div class="text-sm text-slate-600 space-y-2">
        <p>
            <strong>Dependency paths</strong> show how a package is reached from top-level system components.
            The path starts from root nodes (like system-path) and follows the dependency chain down to the target package.
        </p>
        <p>
            <strong>Different paths</strong> between configurations can indicate:
        </p>
        <ul class="list-disc list-inside ml-4 space-y-1">
            <li>A package was added through different modules</li>
            <li>Configuration changes affected the dependency tree</li>
            <li>Different top-level packages pull in the same dependency</li>
        </ul>
    </div>
</div>

<!-- Back to Comparison -->
<div class="mt-6 text-center">
    <a href="/compare?left={{ left.id }}&right={{ right.id }}"
       class="inline-block px-4 py-2 border border-slate-300 text-slate-700 rounded hover:bg-slate-50 transition">
        Back to Comparison
    </a>
</div>
{% endblock %}
