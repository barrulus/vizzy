{% extends "base.html" %}

{% block title %}{{ label }} Flow - {{ import_info.name }}{% endblock %}

{% block head_extra %}
<script src="https://cdn.plot.ly/plotly-2.27.0.min.js"></script>
{% endblock %}

{% block content %}
<div class="mb-4">
    <nav class="text-sm text-slate-500">
        <a href="/" class="hover:text-slate-700">Home</a>
        <span class="mx-2">&gt;</span>
        <a href="/explore/{{ import_info.id }}" class="hover:text-slate-700">{{ import_info.name }}</a>
        <span class="mx-2">&gt;</span>
        <a href="/analyze/duplicates/{{ import_info.id }}" class="hover:text-slate-700">Duplicates</a>
        <span class="mx-2">&gt;</span>
        <a href="/analyze/compare/{{ import_info.id }}/{{ label }}" class="hover:text-slate-700">{{ label }}</a>
        <span class="mx-2">&gt;</span>
        <span class="text-slate-700">Flow Diagram</span>
    </nav>
</div>

<div class="bg-white rounded-lg shadow p-6">
    <div class="flex items-center justify-between mb-4">
        <div>
            <h1 class="text-2xl font-bold">Why does {{ label }} have {{ variant_count }} variants?</h1>
            <p class="text-slate-600">
                {% if is_filtered %}
                Showing dependency flow from <strong>{{ filter_app }}</strong> to package variants
                {% else %}
                Showing dependency flow from top-level applications to package variants
                {% endif %}
            </p>
        </div>
    </div>

    <!-- Application Filter Controls -->
    {% if available_apps and available_apps|length > 0 %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-4">
        <form method="GET" action="/analyze/sankey/{{ import_info.id }}/{{ label }}" class="flex flex-wrap items-center gap-4">
            <label for="filter_app" class="text-sm font-medium text-blue-800">
                Filter by application:
            </label>
            <select
                name="filter_app"
                id="filter_app"
                class="border border-blue-300 rounded-lg px-3 py-2 text-sm bg-white focus:ring-2 focus:ring-blue-500 focus:border-blue-500"
                onchange="this.form.submit()"
            >
                <option value="">All applications ({{ available_apps|length }})</option>
                {% for app in available_apps %}
                <option value="{{ app.label }}" {% if filter_app == app.label %}selected{% endif %}>
                    {{ app.label }}{% if app.closure_size %} ({{ app.closure_size }} deps){% endif %}
                </option>
                {% endfor %}
            </select>
            {% if is_filtered %}
            <a href="/analyze/sankey/{{ import_info.id }}/{{ label }}"
               class="text-sm text-blue-600 hover:text-blue-800 underline">
                Clear filter
            </a>
            {% endif %}
            <noscript>
                <button type="submit" class="px-3 py-2 text-sm bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    Apply
                </button>
            </noscript>
        </form>
        {% if is_filtered %}
        <p class="text-sm text-blue-700 mt-2">
            Showing only the paths from <strong>{{ filter_app }}</strong> to {{ label }} variants.
            This helps understand why this specific application requires {{ label }}.
        </p>
        {% else %}
        <p class="text-sm text-blue-700 mt-2">
            Select an application to see only its paths to {{ label }} variants.
        </p>
        {% endif %}
    </div>
    {% endif %}

    <!-- Flow direction explanation -->
    <div class="bg-slate-50 border border-slate-200 rounded-lg p-4 mb-4">
        <div class="flex items-start gap-4">
            <div class="flex items-center gap-2">
                <div class="flex items-center gap-1">
                    <div class="w-4 h-4 rounded" style="background: #3b82f6"></div>
                    <span class="text-sm font-medium">Top-level apps</span>
                </div>
                <span class="text-slate-400">-></span>
                <div class="flex items-center gap-1">
                    <div class="w-4 h-4 rounded" style="background: #f59e0b"></div>
                    <span class="text-sm font-medium">Intermediate deps</span>
                </div>
                <span class="text-slate-400">-></span>
                <div class="flex items-center gap-1">
                    <div class="w-4 h-4 rounded" style="background: #10b981"></div>
                    <span class="text-sm font-medium">{{ label }} variants</span>
                </div>
            </div>
        </div>
        <p class="text-sm text-slate-600 mt-2">
            {% if top_level_count > 0 %}
            {{ top_level_count }} top-level package{{ 's' if top_level_count != 1 else '' }}
            {% if intermediate_count > 0 %}
            pull in {{ label }} through {{ intermediate_count }} intermediate dependenc{{ 'ies' if intermediate_count != 1 else 'y' }}.
            {% else %}
            directly depend on {{ label }}.
            {% endif %}
            {% else %}
            Tracing why each variant exists in your closure.
            {% endif %}
        </p>
    </div>

    <div id="sankey-diagram" style="width: 100%; height: 600px;"></div>

    <!-- Help text -->
    <div class="mt-4 text-sm text-slate-500">
        <p>
            <strong>Reading this diagram:</strong>
            Flow goes from left to right. The left side shows which top-level packages (apps you requested)
            ultimately require this package. The right side shows the different variants (derivations) that exist.
            Multiple variants often exist because different applications need different build configurations.
        </p>
        {% if available_apps and available_apps|length > 1 %}
        <p class="mt-2">
            <strong>Tip:</strong> Use the application filter above to focus on a single application's dependency path.
            This can help you understand why a specific app pulls in a particular variant.
        </p>
        {% endif %}
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const sankeyData = {{ sankey_data | safe }};

    if (!sankeyData.nodes || !sankeyData.nodes.label || sankeyData.nodes.label.length === 0) {
        document.getElementById('sankey-diagram').innerHTML =
            '<div class="text-center py-12">' +
            '<p class="text-slate-500 mb-2">No flow data available for this package.</p>' +
            '<p class="text-sm text-slate-400">This may happen if the package has no top-level dependents or if top-level package identification has not been run.</p>' +
            '</div>';
        return;
    }

    const data = [{
        type: "sankey",
        orientation: "h",
        arrangement: "snap",
        node: {
            pad: 20,
            thickness: 20,
            line: {
                color: "white",
                width: 1
            },
            label: sankeyData.nodes.label,
            color: sankeyData.nodes.color,
            hovertemplate: '%{label}<br>Value: %{value}<extra></extra>'
        },
        link: {
            source: sankeyData.links.source,
            target: sankeyData.links.target,
            value: sankeyData.links.value,
            color: 'rgba(100, 100, 100, 0.15)',
            hovertemplate: '%{source.label} -> %{target.label}<br>Flow: %{value}<extra></extra>'
        }
    }];

    const layout = {
        font: {
            size: 11,
            family: 'ui-sans-serif, system-ui, sans-serif'
        },
        margin: {
            l: 10,
            r: 10,
            t: 20,
            b: 10
        },
        paper_bgcolor: 'transparent',
        plot_bgcolor: 'transparent'
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        modeBarButtonsToRemove: ['lasso2d', 'select2d'],
        displaylogo: false
    };

    Plotly.newPlot('sankey-diagram', data, layout, config);
});
</script>
{% endblock %}
